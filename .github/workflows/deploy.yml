name: Deploy AI Service

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # STAP 1: Maak .env bestand (Jouw toegevoegde stukje)
      - name: Create .env file
        run: |
          # --- GEHEIMEN UIT GITHUB ---
          echo "MONGO_URI=${{ secrets.MONGO_URI }}" > .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "CORS_POLICY=${{ secrets.CORS_POLICY }}" >> .env

          # --- STANDAARD INSTELLINGEN ---
          echo "DB_NAME=KeuzeKompas" >> .env
          echo "COLLECTION_NAME=modules" >> .env
          echo "JWT_ALGORITHM=HS256" >> .env

      # STAP 2: Stop oude container
      - name: Stop old container
        run: docker rm -f ai-service || true

      # STAP 3: Bouw de image
      - name: Build Image
        run: docker build -t ai-service .

      # STAP 4: Start de container
      # Let op: ik heb '--env-file .env' toegevoegd zodat hij stap 1 gebruikt
      - name: Run Container
        run: |
          docker run -d \
            --name ai-service \
            --network keuzekompas-net \
            --restart always \
            --env-file .env \
            -p 8000:80 \
            ai-service

      # STAP 5: Ruim oude troep op
      - name: Cleanup
        run: docker image prune -f
