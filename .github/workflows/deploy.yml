name: Deploy Backend API

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # STAP 1: Maak .env bestand
      # We combineren hier Secrets (veilig) met hardcoded settings (handig)
      - name: Create .env file
        run: |
          # --- GEHEIMEN UIT GITHUB ---
          echo "MONGO_URI=${{ secrets.MONGO_URI }}" > .env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> .env
          echo "CORS_POLICY=${{ secrets.CORS_POLICY }}" >> .env

          # --- STANDAARD INSTELLINGEN ---
          echo "DB_NAME=KeuzeKompas" >> .env
          echo "COLLECTION_NAME=modules" >> .env
          echo "JWT_ALGORITHM=HS256" >> .env
          
          # De link naar je AI (Publieke URL, zoals net getest!)
          echo "AI_SERVICE_URL=https://keuzekompasai.clemens05.nl" >> .env

      # STAP 2: Stop oude container
      - name: Stop old container
        run: docker rm -f backend-api || true

      # STAP 3: Bouw nieuwe image
      - name: Build Image
        run: docker build -t backend-api .

      # STAP 4: Start container
      # Let op: -p 8000:80 (zodat Nginx erbij kan)
      # Let op: --env-file .env (zodat hij de settings hierboven pakt)
      - name: Run Container
        run: |
          docker run -d \
            --name backend-api \
            --network keuzekompas-net \
            --restart always \
            --env-file .env \
            -p 8000:80 \
            backend-api

      # STAP 5: Opruimen
      - name: Cleanup
        run: docker image prune -f
